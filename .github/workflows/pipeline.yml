name: Pipeline Unificado - Sistema VR

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      ambiente:
        description: 'Ambiente de execução'
        required: false
        default: 'producao'
        type: choice
        options:
        - producao
        - desenvolvimento
        - debug

env:
  PYTHON_VERSION: '3.11'

jobs:
  pipeline-vr:
    name: Pipeline Completo Sistema VR
    runs-on: ubuntu-latest
    env:
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
    steps:
    - name: Checkout código
      uses: actions/checkout@v4
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    - name: Cache uv
      uses: actions/cache@v3
      with:
        path: ~/.cache/uv
        key: ${{ runner.os }}-uv-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-uv-
    - name: Instalar uv
      run: |
        curl -LsSf https://astral.sh/uv/install.sh | sh
        echo "$HOME/.cargo/bin" >> $GITHUB_PATH
    - name: Setup ambiente
      run: make install 
    - name: Testar API do Google Gemini
      run: make test-api
    - name: Executar pipeline completo
      run: |
        echo "# config.py gerado automaticamente pelo GitHub Actions" > config.py
        echo "GOOGLE_API_KEY = \"$GOOGLE_API_KEY\"" >> config.py
        echo "NOME_MODELO_LLM = \"gemini-2.0-flash-001\"" >> config.py
        cat config.py
        make run
      env:
        GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      continue-on-error: true
    - name: Upload dos Outputs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sistema-vr-outputs-${{ github.run_number }}
        path: |
          output/
          !output/logs/*.log
        retention-days: 30
    - name: Upload dos Logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: sistema-vr-logs-${{ github.run_number }}
        path: output/logs/
        retention-days: 7
